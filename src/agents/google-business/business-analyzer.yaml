# Business Analyzer Agent
# Analyzes Google Business Profile reviews and generates insights
#
# Required Environment Variables:
# - GOOGLE_CLIENT_ID
# - GOOGLE_CLIENT_SECRET
# - GOOGLE_REFRESH_TOKEN
# - GEMINI_API_KEY (for AI analysis)
#
# Input:
# - accountId: Google Business Account ID
# - locationId: Location ID to analyze

metadata:
  name: "Business Analyzer"
  version: "1.1.0"
  description: "Analyzes business reviews and generates actionable insights"
  builtin: true

workflow:
  # Step 1: Fetch all reviews with auto-pagination
  - id: "fetch-reviews"
    type: "google-business"
    config:
      action: "listReviews"
      accountId: "$input.accountId"
      locationId: "$input.locationId"
      pageSize: 100
      maxPages: 10
      orderBy: "update_time desc"
    result: "reviewsData"

  # Step 2: Analyze reviews with AI
  - id: "analyze-sentiment"
    type: "llm"
    config:
      provider: "google"
      model: "gemini-2.0-flash-exp"
      system: |
        You are a business analytics expert. Analyze the provided reviews and generate a comprehensive report.
        
        Your analysis must include:
        1. Overall sentiment score (1-10)
        2. Top 5 positive themes with mention counts
        3. Top 5 areas for improvement with mention counts
        4. Reviews requiring urgent response (rating <= 2)
        5. Trend analysis comparing recent vs older reviews
        6. Actionable recommendations
        
        Return ONLY valid JSON (no markdown, no ```):
        {
          "sentimentScore": 8,
          "positiveThemes": [{"theme": "Great service", "count": 15}],
          "improvementAreas": [{"area": "Wait times", "count": 5}],
          "urgentReviews": [{"reviewId": "xxx", "rating": 1, "issue": "summary"}],
          "trendAnalysis": "Recent reviews show improvement...",
          "recommendations": ["Focus on...", "Consider..."]
        }
      messages:
        - role: "user"
          content: "$input.reviewsPayload"
    result: "analysisRaw"

  # Step 3: Parse analysis JSON
  - id: "parse-analysis"
    type: "output-generator"
    config:
      json: "$stepResult.analysisRaw.text"
    result: "analysis"

  # Step 4: Generate response suggestions for negative reviews
  - id: "generate-responses"
    type: "llm"
    config:
      provider: "google"
      model: "gemini-2.0-flash-exp"
      system: |
        You are a customer service expert. For each negative review (rating <= 3),
        generate a professional, empathetic response suggestion.
        
        Guidelines:
        - Acknowledge the customer's concern
        - Apologize for their experience
        - Offer a solution or next steps
        - Keep responses under 150 words
        - Be specific to the complaint mentioned
        
        Return ONLY valid JSON array (no markdown, no ```):
        [{"reviewId": "xxx", "rating": 2, "originalComment": "...", "suggestedResponse": "..."}]
        
        If no negative reviews, return: []
      messages:
        - role: "user"
          content: "$input.reviewsPayload"
    result: "responsesRaw"

  # Step 5: Parse responses JSON
  - id: "parse-responses"
    type: "output-generator"
    config:
      json: "$stepResult.responsesRaw.text"
    result: "responseSuggestions"

# Explicit Return: Define the API response contract
return:
  success: true
  summary:
    totalReviews: "$stepResult.reviewsData.totalReviewCount"
    averageRating: "$stepResult.reviewsData.averageRating"
    pagesFetched: "$stepResult.reviewsData.data.pagesFetched"
  analysis: "$stepResult.analysis"
  responseSuggestions: "$stepResult.responseSuggestions"
  reviews: "$stepResult.reviewsData.reviews"
